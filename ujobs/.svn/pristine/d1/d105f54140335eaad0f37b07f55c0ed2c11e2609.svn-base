/*! luozh 2015-09-16 */
$(function(){var a=["/restart/","/modify_pwd/","/script/","/send_file/","/md_manage/","/example_manage/","/script_manage/","/timing_manage/","/account/add/","/account/","/history/","/agent/","/view_status/"],b=["批量重启","批量改密","执行脚本","分发文件","作业模板管理","作业实例管理","作业脚本管理","定时调度管理","登记执行账户","执行账户管理","作业执行历史","查看agent状态","查看系统状态"],c=["restart","modify_pwd","script","send_file","md_manage","example_manage","script_manage","timing_manage","account_add","account","history","agent","view_status"];$(".nav-list li a").each(function(d){$(this).click(function(){var e=d+1;return d>-1&&(e=d+2),d>4&&(e=d+3),d>7&&(e=d+4),d>9&&(e=d+5),d>11&&(e=d+6),d>12&&(e=d+7),$(".nav-list li:eq("+e+")").addClass("active"),$("#loading-panel").show().css({"z-index":1e3}).animate({opacity:"1"},100),"//"==a[d]?!1:void("/script/"==a[d]?$.ajax({type:"GET",url:a[d],data:{done:"ok"},dataType:"json",success:function(a){$("#li_"+c[d]).length&&$("#li_"+c[d]).length>0?$('#myTab a[aria-controls="'+c[d]+'"]').tab("show"):($("#myTab").prepend('<li id="li_'+c[d]+'" role="presentation" style="  position: relative;" ><i onclick="close_tab(this)" class="icon-remove mytab-close"></i><a href="#'+c[d]+'" aria-controls="'+c[d]+'" role="tab" data-toggle="tab" onclick="active_menu(this);" style="padding-right: 24px;"><label class="tab-ellipsis">'+b[d]+"</label></a></li>"),$("#tabs>.tab-content").prepend('<div role="tabpanel" class="tab-pane show-already" id="'+c[d]+'">'+a.html+"</div>"),$("#myTab a:first").tab("show")),show_tab_arrow(),$("#loading-panel").animate({opacity:"0"},200).hide().css({"z-index":-999}),$("#script").removeClass("show-already")},error:function(a,b){}}):($("#li_"+c[d]).length&&$("#li_"+c[d]).length>0?$('#myTab a[aria-controls="'+c[d]+'"]').tab("show"):($("#myTab").prepend('<li id="li_'+c[d]+'" role="presentation" style="  position: relative;" ><i onclick="close_tab(this)" class="icon-remove mytab-close"></i><a href="#'+c[d]+'" aria-controls="'+c[d]+'" role="tab" data-toggle="tab" onclick="active_menu(this);" style="padding-right: 24px;"><label class="tab-ellipsis">'+b[d]+"</label></a></li>"),$("#tabs>.tab-content").prepend('<div role="tabpanel" class="tab-pane" id="'+c[d]+'"></div>'),$("#"+c[d]).load(a[d]),$("#myTab a:first").tab("show")),show_tab_arrow(),$("#loading-panel").animate({opacity:"0"},200).hide().css({"z-index":-999})))})}),$(".popovers").popover(),$("#startJobs").css({width:"1350px","margin-left":function(){return-($(this).width()/2)},height:"710px","margin-top":function(){return-($(this).height()/2)}}),$.fn.dataTableExt.oApi.fnReloadAjax=function(a,b,c,d){if("undefined"!=typeof b&&null!=b&&(a.sAjaxSource=b),a.oFeatures.bServerSide)return void this.fnDraw();this.oApi._fnProcessingDisplay(a,!0);var e=this,f=a._iDisplayStart,g=[];this.oApi._fnServerParams(a,g),a.fnServerData.call(a.oInstance,a.sAjaxSource,g,function(b){e.oApi._fnClearTable(a);for(var g=""!==a.sAjaxDataProp?e.oApi._fnGetObjectDataFn(a.sAjaxDataProp)(b):b,h=0;h<g.length;h++)e.oApi._fnAddData(a,g[h]);a.aiDisplay=a.aiDisplayMaster.slice(),"undefined"!=typeof d&&d===!0?(a._iDisplayStart=f,e.fnDraw(!1)):e.fnDraw(),e.oApi._fnProcessingDisplay(a,!1),"function"==typeof c&&null!=c&&c(a)},a)};var d="startJobs",e=function(){var a=1;window.localStorage?localStorage.setItem(d,a):Cookie.write(d,a)},f=window.localStorage?localStorage.getItem(d):Cookie.read(d);("1"==f||void 0==f)&&($("#startJobs").removeClass("hide"),$("#startJobs").modal({show:!0}).css({width:"1350px","margin-left":function(){return-($(this).width()/2)},height:"710px","margin-top":function(){return-($(this).height()/2)}}),ani_start()),"1"!=f&&void 0!=f&&($("#updatemodel").removeClass("hide"),$("#updatemodel").modal({show:!0}).css({width:"650px","margin-left":function(){return-($(this).width()/2)},height:"480px","margin-top":function(){return-($(this).height()/2)}})),e(),$("#nav-hide-menu").bind("click",function(){$(this).hide(),$(".span10").animate({"padding-left":"8%","padding-right":"5%"}),$(".bggray").animate({"margin-left":"-17.893617%"},400,function(){$(".nav-show-menu").css("display","block")})}),$(".nav-show-menu").click(function(){$(".ujobs-logo").width();$(".nav-show-menu").hide(),$(".bggray").animate({"margin-left":"0%"},400,function(){$("#nav-hide-menu").show()}),$(".span10").animate({"padding-left":"2.564102564102564%","padding-right":"0%"})}),$("#myTab").on("contextmenu","li",function(a){"function"==typeof a.preventDefault?(a.preventDefault(),a.stopPropagation()):(a.returnValue=!1,a.cancelBubble=!0),$(this).addClass("an").siblings("li").removeClass("an");var b=$("#menu_ul").width(),c=$(".bggray").css("margin-left");"0%"==c||"0px"==c?$("#menu-context").css({left:a.clientX-b,top:a.clientY-65}).fadeIn():$("#menu-context").css({left:a.clientX,top:a.clientY-65}).fadeIn(),$(".close-tab1").bind("click",function(){$(".an i").trigger("click"),show_tab_arrow()}),$(".close-tab2").bind("click",function(){$(".an").siblings().find("i").trigger("click"),show_tab_arrow()}),$(".close-tab3").bind("click",function(){$("#myTab>li").find("i").trigger("click"),show_tab_arrow(),0!=$("#loading-panel").length&&$("#loading-panel").animate({opacity:"0"},200).hide(),$(".last-panel").addClass("active"),$(".last-panel").delay(1500).animate({left:"-50%"},800)})}),$(document).bind("click",function(a){$("#menu-context").hide(),$("#myTab li.an").removeClass("an")});var g=$("#menu_ul").width();$(".ujobs-logo").css("width",g-1),$(window).resize(function(){var a=$("#menu_ul").width();$(".ujobs-logo").css("width",a-1)}),$("#new_hand_step").on("click",function(){ani_start()}),$(document).on("click","#startJobs .close",function(){$(".step-show1 span").prop("class",""),$(".step-show1 span").prop("class","")}),$(document).on("click",".caret-arrow-up",function(){$(this).parent().siblings().hide(),$(this).removeClass("caret-arrow-up").addClass("caret-arrow-down")}),$(document).on("click",".caret-arrow-down",function(){$(this).parent().siblings().show(),$(this).removeClass("caret-arrow-down").addClass("caret-arrow-up")}),$(document).on("click",".reset",function(){$(this).parents(".form-search").find(".controls input,.controls textarea").val(""),$(this).parents(".form-search").find(".controls select").each(function(){$(this).find("option").eq(0).prop("selected",!0)})});var h=".edit_checked_all",i=".edit_checked_it";check_all(h,i),$(document).on("click","#update_script_reset",function(){return $(".md-search-txt").val(""),!1}),$(document).on("click",".full-set",function(){var a=$(this).attr("data-msg");$(this).parents("."+a).addClass("hide").siblings(".full-set-wrap").removeClass("hide")}),$(document).on("click",".full-set-back",function(){var a=$(this).attr("data-msg");return $(this).parents(".full-set-wrap").addClass("hide").siblings("."+a).removeClass("hide"),!1}),$(document).off("click",".add_step_choose li a").on("click",".add_step_choose li a",function(){var a=$(this),b=a.parents(".edit-md-wrap"),c=b.find(".edit_md_table tbody");b.find(".edit_md_table .dataTables_empty").parent().remove();var d=a.text(),e=c.find("tr").length,f=a.parent("li").attr("value"),g=c.attr("template_id");$.ajax({type:"POST",url:"/md_manage/template_step/add/",data:{index:e,type_value:f,template_id:g},dataType:"json",success:function(b){if(200==b.status){var e=b.result.step_id;c.append("<tr step_id="+e+"><td></td><td><a href='javascript:void(0)' onclick='template_step_edit("+e+");'>"+d+"</a></td><td>"+d+"</td><td><div class='btn-group'><a class='dropdown-toggle' data-toggle='dropdown' href='#'>增加步骤</a><ul class='dropdown-menu add-step-list'><li value='1'><a>执行脚本</a></li><li value='2'><a>分发文件</a></li><li value='3'><a>拉取文件</a></li><li value='4'><a>文本步骤</a></li></ul></div>&nbsp;&nbsp;<a href='javascript:void(0)' class='remove-step' step_id="+e+">删除</a></td></tr>"),sort_step(a)}else jError("操作失败！")}})}),$(document).off("click",".add-step-list li a").on("click",".add-step-list li a",function(){var a=$(this),b=a.parents(".edit-md-wrap"),c=b.find(".edit_md_table tbody");b.find(".edit_md_table .dataTables_empty").parent().remove();var d=a.text(),e=a.parents("tr").prevAll().length+1,f=a.parent("li").attr("value"),g=c.attr("template_id");$.ajax({type:"POST",url:"/md_manage/template_step/add/",data:{index:e,type_value:f,template_id:g},dataType:"json",success:function(b){if(200==b.status){var c=b.result.step_id;a.parents("tr").after("<tr step_id="+c+"><td></td><td><a href='javascript:void(0)' onclick='template_step_edit("+c+");'>"+d+"</a></td><td>"+d+"</td><td><div class='btn-group'><a class='dropdown-toggle' data-toggle='dropdown' href='#'>增加步骤</a><ul class='dropdown-menu add-step-list'><li value='1'><a>执行脚本</a></li><li value='2'><a>分发文件</a></li><li value='3'><a>拉取文件</a></li><li value='4'><a>文本步骤</a></li></ul></div>&nbsp;&nbsp;<a href='javascript:void(0)' class='remove-step' step_id="+c+">删除</a></td></tr>"),sort_step(a)}else jError("操作失败！")}})}),$(document).off("click",".remove-step").on("click",".remove-step",function(){var a=$(this);if(1==confirm("是否真的要删除该步骤？")){var b=a.attr("step_id");$.ajax({url:"/md_manage/template_step/delete/"+b+"/",dataType:"json",success:function(b){if(200==b.status){template_steps_table.fnReloadAjax();var c=a.parents(".edit-md-wrap");a.parents("tr").remove(),c.find(".edit_md_table tbody tr").each(function(){var b=a.index()+1;a.find("td:first").html("第"+b+"步")}),jSuccess(b.result.msg)}else 500==b.status&&jError(b.result.msg)},error:function(a,b){jError("出错了")}})}else jNotify("操作已取消")});var j;$(document).on("click",".select-servers",function(){var a="."+$(this).attr("data-msg"),b=$(this).parents(a).siblings(".set-model"),c=b.find(".ujobs-cmdb-tree");c.on("changed.jstree",function(a,b){j=b.selected}).jstree({plugins:["checkbox"],core:{themes:{theme:"classic",dots:!0,icons:!0},dataType:"json",data:{url:"/usual/ajax_get_cmdb_node_returns/",data:function(a){return{nodeid:a.id}}}}}),$(document).off("click",".add-servers-ip").on("click",".add-servers-ip",function(){var a=$(this).attr("data-msg"),b=$(this).parents(".set-model").siblings(".edit-"+a+"-wrap"),c=b.find(".select-servers"),d=b.find(".edit-"+a+"-ip-result"),e=b.find(".edit-"+a+"-ip-hide"),f=b.find(".add-btn-status"),g=b.find(".edit-"+a+"-save"),h=b.find(".edit-"+a+"-ip-wrap");d.parent().removeClass("hide"),d.empty(),$.ajax({type:"post",url:"/usual/ajax_get_cmdb_subnode_returns/",data:{nodeid:j},dataType:"json",success:function(a){if(""==a)return jNotify("所选机器下没有ip信息"),!1;e.val("");for(var b=e.val(),i=a.split(","),j=0;j<i.length;j++)d.append("<li><i class='ipconfig'>"+i[j]+"</i><i i class='loading'><img width='20px' src='/static/assets/img/loading.gif'></i></li>");return f.addClass("disabled"),g.addClass("disabled"),c.button("loading"),$.ajax({type:"POST",url:"/ajax_cmdb_valid/",data:{iptxt:a,hidetxt:b},dataType:"json",error:function(a){return jError(a.responseText),f.removeClass("disabled"),g.removeClass("disabled"),c.button("complete").html("<i class='icon-th-list'></i>选择目标机器 "),h.empty(),!1},success:function(a){d.parent().removeClass("hide"),e.val(a.ip_dict);var b=$.parseJSON(a.ip_dict);h.find("b").html("涉及服务器["+b.total+"]台，仅["+b.num+"]台支持操作"),d.empty(),vaild_ipfree(b,d),f.removeClass("disabled"),g.removeClass("disabled"),c.button("complete").html("<i class='icon-th-list'></i>选择目标机器 ")}}),!0},error:function(){jError("请求失败！选择目标机器失败！")}})})}),$(document).on("ifClicked",".check-toggle",function(){var a=$(this).parents(".edit-script-wrap"),b=$(this).attr("data-msg"),c=".check-toggle-"+b;check_toggle($(this),a,c)}),$(document).on("ifClicked",".check-toggle3",function(){var a=$(this).parents(".edit-sendfile-wrap"),b=".check-toggle-box3";check_toggle($(this),a,b)}),$(document).on("ifClicked",".edit-sendfile-btn",function(){var a=$(this).parents(".edit-sendfile-wrap"),b=$(this).attr("data-msg"),c=$(this).attr("data-msg2");a.find(".edit-sendfile-"+b).removeClass("hide"),a.find(".edit-sendfile-"+c).addClass("hide")}),$(document).on("ifChecked","#send_file_location_remote",function(){$("#local-doc").addClass("hide"),$("#far-doc").removeClass("hide")}),$(document).on("ifChecked","#send_file_location_local",function(){$("#local-doc").removeClass("hide"),$("#far-doc").addClass("hide")}),$(document).on("ifClicked",".check-toggle4",function(){var a=$(this).parents(".edit-pullfile-wrap"),b=".check-toggle-box4";check_toggle($(this),a,b)}),$(document).on("click",".p-filefind",function(){var a=$(this).attr("data-msg"),b=$(this).parents(".edit-"+a+"-wrap"),c=b.find(".edit-"+a+"-upField"),d=b.find(".edit-"+a+"-docfield");flie_upload2(c,d)}),$(document).on("ifChecked",".localscript",function(){$(this).parents(".row-fluid").find(".local-find").removeClass("hide")}),$(document).on("ifChecked",".handscript",function(){$(this).parents(".row-fluid").find(".local-find").addClass("hide")}),$(document).on("ifClicked",".rule-show",function(){var a=$(this).parents(".modify-timing-modal"),b=".rule-txt";check_toggle($(this),a,b)});var k=1;$(document).on("click",".ip-add-btn",function(){var a=$(this).attr("data-msg"),b=$(this).parents(".edit-"+a+"-wrap"),c=b.find(".edit-"+a+"-ip-hide"),d=b.find(".edit-"+a+"-ip-area"),e=b.find(".edit-"+a+"-ip-result"),f=b.find(".ip-add-btn"),g=b.find(".edit-"+a+"-save"),h=$(".edit-"+a+"-ip-wrap b");if(c.val(""),1==k)add_ipfree(d,c,e,f,g,h,a);else if("pwd"==a){var i="/ajax_pwd_valid/0/";add_ip(d,c,e,f,g,h,i)}else add_ip(d,c,e,f,g,h,i)}),$(document).on("click",".ip-add-btn2",function(){var a=$(this).attr("data-msg"),b=$(this).parents(".edit-"+a+"-wrap"),c=b.find(".edit-"+a+"-ip-hide"),d=b.find(".edit-"+a+"-ip-area"),e=b.find(".edit-"+a+"-ip-result"),f=b.find(".ip-add-btn2"),g=b.find(".edit-"+a+"-save"),h=$(".edit-"+a+"-ip-wrap b");c.val(""),1==k?add_ipfree(d,c,e,f,g,h):add_ip2(d,c,e,f,g,h)}),$(document).on("click",".ip-style span",function(){var a=$(this).parents(".ip-style").attr("data-msg"),b=$(this).parents(".edit-"+a+"-wrap"),c=$(this).siblings(".ipconfig").text(),d=b.find(".edit-"+a+"-ip-hide");delete_ip_hide(d,$(this),$(".edit-"+a+"-ip-wrap b"),c)}),$(document).on("change",".p-upField",function(){var a=$(this).attr("data-msg"),b=$(this).parents(".edit-"+a+"-wrap"),c=b.find(".edit-"+a+"-find"),d=b.find(".edit-"+a+"-upload"),e=b.find(".edit-"+a+"-hash"),f=b.find(".edit-"+a+"-upField");hash_get(c,d,e,f)}),$(document).on("click",".edit-sendfile-upload",function(){var a=$(this).attr("data-size"),b=$(this).attr("data-msg"),c=$(this).parents(".edit-"+b+"-wrap"),d=c.find(".edit-"+b+"-docfield"),e=c.find(".edit-"+b+"-upField"),f=c.find(".edit-"+b+"-hash"),g=c.find(".edit-sendfile-upload"),h=c.find(".edit-"+b+"-ip"),i=c.find(".edit_"+b+"_record"),j=c.find(".edit-"+b+"-form"),k=$("#nav-hide-menu").attr("data-url");load_file(c,d,e,f,g,h,i,j,k,a)}),$(document).on("click",".p-addfile",function(){var a=$(this).attr("data-msg"),b=$(this).parents(".edit-"+a+"-wrap"),c=b.find(".edit-"+a+"-ipserver"),d=b.find(".edit-"+a+"-hidelists"),e=b.find(".edit-"+a+"-filelists"),f=b.find(".p-addfile"),g=b.find(".edit-"+a+"-ip"),h=b.find(".edit-"+a+"-account option:selected");add_filelists(c,d,e,f,g,h)}),$(document).off("click",".edit-pullfile-addfile").on("click",".edit-pullfile-addfile",function(){var a=$(this).parents(".edit-pullfile-wrap"),b=a.find(".edit-pullfile-filelists"),c=a.find(".edit-pullfile-list"),d=b.val().trim();a.find(".edit-pullfile-addfile");if(!d||" "==d)return jNotify("请输入文件名！"),!1;for(var e=d.split("\n"),f=e.length,g=[],h=0;f>h;h++)" "!=e[h]&&""!=e[h]&&g.push(e[h]);for(var i=g.length,j="",h=0;i>h;h++)j+="<li class='clearfix list2'>拉取文件：<i class='file-road'>"+g[h]+"</i><i class='ipconfig'></i><i class='server-account'></i><span onclick='del_file(this)'>删除</span></li>";c.append(j),b.val("")}),$(document).on("click",".edit-sendfile-wrap .delete2",function(){var a=$(this).parents(".edit-sendfile-wrap"),b=a.find(".edit-sendfile-hidelists"),c=$(this);del_filelists(c,b)}),$(document).on("click","#send_file_form .delete2",function(){var a=$("#send_file_remote_files_list"),b=$(this);del_filelists(b,a)}),$(document).on("click",".edit-sendfile-wrap .delete1",function(){var a=$(this).parents(".edit-sendfile-wrap"),b=a.find(".edit_sendfile_record"),c=$(this);del_filelists2(c,b)}),$(document).on("click","#send_file_form .delete1",function(){var a=$("#send_file_record_ids"),b=$(this);del_filelists2(b,a)}),$(document).on("keyup",".ujobs_timeout",function(){$(this).val()>=259200&&$(this).val("259200")}),$(".ujobs-logo img").mouseover(function(){var a=0,b=$(this),c=setInterval(function(){a>parseInt(b.width()+50)&&clearInterval(c),b.css({"-webkit-mask":"-webkit-gradient(radial, 88 53,"+a+", 88 53, "+(a+15)+", from(rgba(255, 255, 255,0.9)), color-stop(0.5, rgba(255, 255, 255, 0.2)), to(rgba(255, 255, 255,1)))"}),a++},0)}),$(document).on("click",".paginate_button,.paginate_active,.sorting,.sorting_asc,.sorting_desc",function(){var a=$(this).parents(".dataTables_wrapper"),b=a.find("tbody input:checkbox"),c=a.find("thead input:checkbox");b.prop("checked",!1),c.prop("checked",!1)}),$(document).on("ifClicked","#more-choose",function(){0==$("#more-choose").prop("checked")?($("#timeout").css("display","block"),$("#parameter").css("display","block")):($("#timeout").css("display","none"),$("#parameter").css("display","none"),$("#script_once_timeout").val(""),$("#script_once_parameter").val(""))}),$(document).on("click","#view_update",function(){$('#myTab a[aria-controls="update"]').tab("show")})});