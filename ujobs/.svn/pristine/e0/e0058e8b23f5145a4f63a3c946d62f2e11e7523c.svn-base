/*! luozh 2015-09-16 */
function icheck(a){a.iCheck({checkboxClass:"icheckbox_minimal-grey",radioClass:"iradio_minimal-grey",increaseArea:"20%"})}function active_menu(a){$("#menu_ul li").removeClass("active");var b=$(a).parent().attr("id");$("#menu_"+b).addClass("active")}function show_tab_arrow(){for(var a=$("#myTab li").length,b=0,c=$("#myTab").width(),d=0;a>d;d++)b+=$("#myTab li").eq(d).width();b>c?$(".tab-arrow").removeClass("hide"):($(".tab-arrow").addClass("hide"),$("#myTab").css("height","47px"),$(".tab-arrow").find("i").removeClass("icon-arrow-up").addClass("icon-arrow-down"))}function close_tab(a){var b=$(a).parent(),c=$(a).next().attr("aria-controls"),d=$("#myTab li.active"),e=d.attr("id");if(b.remove(),$("#"+c).remove(),e=="li_"+c){$("#menu_ul li").removeClass("active");var f=$("#myTab a:first");if(f){f.tab("show");var e=f.parent().attr("id");$("#menu_"+e).addClass("active")}}show_tab_arrow()}function ajax_add_account(a){var b=$(a).parents(".modal");return $.ajax({type:"POST",url:"/account/ajax_add_account/",data:$("#ajaxaccountform").serialize(),dataType:"json",success:function(a){b.empty(),b.html(a.html),1==a.result?(jSuccess("保存账户成功！"),b.modal("hide")):jError("保存账户失败")},error:function(){jError("保存账户错误！")}}),!0}function codeMirror(a,b,c,d,e,f,g){c.change(function(){var b=c.val();a.setOption("theme",b)}),c.trigger("change");var h=b.val(),i="",j=d.val(),k=f,l=g;e.on("ifChecked",function(){var b=(a.getValue(),$(this).prop("id"));b==k?(a.setOption("mode","shell"),a.setValue(h)):b==l?(a.setOption("mode","perl"),a.setValue(i)):(a.setOption("mode","python"),a.setValue(j))})}function codeMirror2(a,b,c){var a=CodeMirror.fromTextArea(b[0],{lineNumbers:!0,mode:"shell",lineWrapping:!0});c.change(function(){var b=c.val();a.setOption("theme",b)}),c.trigger("change")}function flie_upload2(a,b){a.trigger("click"),b.val(a.val()),a.change(function(){b.val(a.val())})}function load_file(a,b,c,d,e,f,g,h,i,j){var k=b.val();if(!k)return jNotify("请选择上传文件!"),!1;if(!check_size(c,j))return!1;var l=c.get(0).files[0],m=d.val();$.ajax({url:"/files/file_exists/",type:"POST",dataType:"json",data:{md5sum:m,size:l.size,file_name:l.name},success:function(d){if(200==d.status)if(1==d.result.existed)e.button("complete").html("<i class='icon-arrow-up'></i>导入"),f.parent().removeClass("hide"),f.append("<li>本地文件："+k+"<i class='file-id' style='display:none;'>"+d.result.record_id+"</i><span class='delete1'>删除</span></li>"),b.val(""),c.val(""),g.val(g.val()+a.find(".file-id").last().text()+" "),jSuccess("文件上传成功！");else{var j=new FormData(h[0]);e.button("loading"),$.ajax({url:i,type:"POST",dataType:"json",data:j,success:function(d){e.button("complete").html("<i class='icon-arrow-up'></i>导入"),200==d.status?(f.parent().removeClass("hide"),f.append("<li>本地文件："+k+"<i class='file-id' style='display:none;'>"+d.result.record_id+"</i><span class='delete1'>删除</span></li>"),b.val(""),c.val(""),g.val(g.val()+a.find(".file-id").last().text()+" "),jSuccess("文件上传成功！")):jNotify(d.result.msg)},error:function(){e.button("complete").html("<i class='icon-arrow-up'></i>导入"),jError("文件上传出错，请重试！")},cache:!1,contentType:!1,processData:!1})}else jNotify(d.result.msg)},error:function(){jError("文件检查出错")},cache:!1})}function check_size(a,b){var c=a.get(0).files[0];if(!c)return jError("请选择上传文件"),!1;return c.size>1048576*b?(jError("文件大小不能大于100M"),!1):c.size<0?(jError("文件大小不能为0"),!1):!0}function hash_get(a,b,c,d){function e(){var a=currentChunk*chunkSize,b=a+chunkSize>=file.size?file.size:a+chunkSize;f.readAsBinaryString(blobSlice.call(file,a,b))}if(!check_size(d))return!1;a.button("loading"),b.addClass("disabled");var f=new FileReader,g=c;blobSlice=File.prototype.mozSlice||File.prototype.webkitSlice||File.prototype.slice,file=d.get(0).files[0],chunkSize=2097152,chunks=Math.ceil(file.size/chunkSize),currentChunk=0,spark=new SparkMD5,f.onload=function(c){if(console.log("read chunk nr",currentChunk+1,"of",chunks),spark.appendBinary(c.target.result),currentChunk++,currentChunk<chunks)e();else{console.log("finished loading");var d=spark.end();g.val(d),console.info("computed hash",d),a.button("complete").html("<i class='icon-folder-open'></i>浏览..."),b.removeClass("disabled")}},e()}function add_filelists(a,b,c,d,e,f){var g=a.val().trim().replace(new RegExp("	","g")," "),h=(b.val().trim(),c.val().trim().split("\n")),i=h.length;if(!g)return jNotify("请填写ip信息！"),a.focus(),!1;if(!c.val().trim())return jNotify("请填写分发路径！"),c.focus(),!1;var j=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;return j.test(g)?(d.button("loading"),$.ajax({type:"POST",url:"/ajax_agent_valid/",data:{iptxt:g},dataType:"json",error:function(a){return jError(a.responseText),!1},success:function(a){d.button("complete").html("<i class='icon-plus'></i>添加待分发文件"),e.parent().removeClass("hide"),b.val("");var c=$.parseJSON(a.ip_dict);for(var g in c)if("total"!=g&&"num"!=g){var j=c[g],k=j[0];if(1!=k)return 0==k?(jNotify("输入的密码有误！"),!1):-1==k?(jNotify("agent状态异常！"),!1):-2==k?(jNotify("IP输入框格式错误！"),!1):-99==k?(jNotify("agent不存在！"),!1):(jNotify("添加文件出错，请重试！"),!1);e.find(".list2").remove();var l=[];if(""==b.val())var m={remote:[]};else var m=$.parseJSON(b.val());for(var n=0;i>n;n++)""==h[n]?h.splice($.inArray(h[n],h),1):l.push(h[n]);for(var o=0;o<l.length;o++){e.append("<li class='clearfix list2'>远程文件：<i class='file-road'>"+l[o]+"</i><i class='ipconfig'>"+g+"</i><i class='server-account'>"+f.text()+"</i><span class='delete2'>删除</span></li>");var j={name:l[o],ip:g,account_id:f.val()};m.remote.push(j)}var c=JSON.stringify(m);b.val(c),jSuccess("添加成功！")}}}),!0):(jNotify("ip输入框格式错误"),!1)}function del_filelists(a,b){var c=a.parent().index(".list2"),d=$.parseJSON(b.val());d.remote.splice(c,1);var e=JSON.stringify(d);b.val(e),a.parent().remove()}function del_filelists2(a,b){var c=a.siblings(".file-id").text(),d=b.val().split(" ");d.splice($.inArray(c,d),1);var e=d.join(" ");b.val(e),a.parent().remove()}function check_all(a,b){$(document).on("click",a,function(){$(this).prop("checked")?$(b).prop("checked",!0):$(b).prop("checked",!1)}),$(document).on("click",b,function(){0==$(this).prop("checked")&&$(a).prop("checked",!1),$(b).filter(":checked").length>=$(b).length&&$(a).prop("checked",!0)})}function time_compare(a,b){var c=a.split("-"),d=b.split("-"),e=new Date(c[0],c[1]-1,c[2]),f=new Date(d[0],d[1]-1,d[2]);return e>f?(jNotify("开始时间不能大于结束时间！"),!1):!0}function tab_href(a,b,c){$("#li_"+a).length&&$("#li_"+a).length>0?($("#"+a).html(c),$('#myTab a[aria-controls="'+a+'"]').tab("show")):($("#myTab").prepend('<li id="li_'+a+'" role="presentation" style="  position: relative;" ><i onclick="close_tab(this)" class="icon-remove mytab-close"></i><a href="#'+a+'" aria-controls="'+a+'" role="tab" data-toggle="tab" style="padding-right: 24px;"><label class="tab-ellipsis">'+b+"</label></a></li>"),$("#tabs>.tab-content").prepend('<div role="tabpanel" class="tab-pane" id="'+a+'"></div>'),$("#"+a).html(c),$("#myTab a:first").tab("show")),show_tab_arrow()}function tab_href2(a,b,c){$("#li_"+a).length&&$("#li_"+a).length>0?$('#myTab a[aria-controls="'+a+'"]').tab("show"):($("#myTab").prepend('<li id="li_'+a+'" role="presentation" style="  position: relative;" ><i onclick="close_tab(this)" class="icon-remove mytab-close"></i><a href="#'+a+'" aria-controls="'+a+'" role="tab" data-toggle="tab" style="padding-right: 24px;"><label class="tab-ellipsis">'+b+"</label></a></li>"),$("#tabs>.tab-content").prepend('<div role="tabpanel" class="tab-pane show-already" id="'+a+'"></div>'),$("#"+a).html(c),$("#myTab a:first").tab("show")),show_tab_arrow(),$("#"+a).removeClass("show-already")}function check_job_name(a,b){var c=a.val(),d=b.val(),e=len2=0,f=getByteLen(c,e),g=getByteLen(d,len2);return f>255?(jNotify("作业名称不能超过255个字符"),!1):g>255?(jNotify("备注不能超过255个字符"),!1):void 0}function getByteLen(a,b){for(var c=0;c<a.length;c++){var d=a.charAt(c);b+=null!=d.match(/[^\x00-\xff]/gi)?2:1}return b}function template_filter(){var a=$("#template_name").val(),b=$("#template_creator").val(),c=$("#template_type").val(),d=$("#template_step").val(),e=$("#template_stime").val(),f=$("#template_etime").val(),g=$("#id_search_type").val(),h=$("#id_search_value").val();template_table.fnReloadAjax("/md_manage/list/?p=0&template_name="+a+"&template_creator="+b+"&template_type="+c+"&template_step="+d+"&template_stime="+e+"&template_etime="+f+"&id_search_type="+g+"&id_search_value="+h)}function schedule_filter(){var a=$("#search_schedule_name").val(),b=$("#search_schedule_creator").val(),c=$("#search_schedule_executor").val(),d=$("#search_schedule_note").val(),e=$("#search_schedule_stime").val(),f=$("#search_schedule_etime").val(),g=$("#search_schedule_status").val();void 0!=schedule_table&&schedule_table.fnReloadAjax("/timing_manage/list/?p=0&name="+a+"&creator="+b+"&executor="+c+"&note="+d+"&stime="+e+"&etime="+f+"&status="+g)}function template_view(a){$.ajax({type:"GET",url:"/md_manage/show/"+a+"/",data:{},dataType:"json",success:function(b){var c="template_view_info_"+a,d="模板【"+b.template_name+"】主页",e=b.html;tab_href(c,d,e)},error:function(){jError("出错了")}})}function compare_ip(a){var b=[];for(i=0;i<a.length;i++){var c=a[i].split(" ");if(1==c.length)return jNotify("格式输入错误，请检查！"),!1;var d=c[0];if(d){if(-1!=$.inArray(d,b))return jNotify("存在重复ip："+d+"，请检查！"),!1;b.push(d)}}}function compare_ipfree(a){var b=[];for(i=0;i<a.length;i++){var c=a[i].trim();if(c){if(-1!=$.inArray(c,b))return jNotify("存在重复ip："+c+"，请检查！"),!1;b.push(c)}}}function filter_ip(a,b){for(var c=0;c<a.length;c++)(""==a[c]||" "==a[c]||"undefined"==typeof a[c])&&(a.splice(c,1),c-=1);for(var c=0;c<a.length;c++)if(-1!=$.inArray(" ",a[c])){var d=a[c].substr(0,a[c].indexOf(" ")),e=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;e.test(d)?b.append("<li class='clearfix'><i class='ipconfig'>"+d+"</i><i class='status1'></i><i class='status2'></i><i class='loading'><img width='20px' src='/static/assets/img/loading.gif'></i></li>"):jNotify("存在错误的ip或输入格式，已过滤。")}else jNotify("存在错误的ip或输入格式，已过滤。")}function filter_ipfree(a,b,c){for(var d=0;d<a.length;d++)(""==a[d]||" "==a[d]||"undefined"==typeof a[d])&&(a.splice(d,1),d-=1);if("pwd"==c)for(var d=0;d<a.length;d++){var e=a[d].trim();if(-1!=$.inArray(" ",e)){var f=e.substr(0,e.indexOf(" ")),g=e.substr(e.indexOf(" ")+1,e.length),h=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;h.test(f)?b.append("<li class='clearfix'><i class='ipconfig'>"+f+"</i><i class='pwdconfig hide'>"+g+"</i><i class='status1'></i><i class='status2'></i><i class='loading'><img width='20px' src='/static/assets/img/loading.gif'></i></li>"):jNotify("存在错误的ip或输入格式，已过滤。")}}else for(var d=0;d<a.length;d++){var f=a[d].trim();if(-1==$.inArray(" ",f)){var h=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;h.test(f)?b.append("<li class='clearfix'><i class='ipconfig'>"+f+"</i><i class='status1'></i><i class='status2'></i><i class='loading'><img width='20px' src='/static/assets/img/loading.gif'></i></li>"):jNotify("存在错误的ip或输入格式，已过滤。")}else jNotify("存在错误的ip或输入格式，已过滤。")}}function vaild_ip(a,b){var c="";for(var d in a){var e=a[d],f=e[0],g=e[2];"total"!=d&&"num"!=d&&1!=f&&(0==f?c+="<li class='clearfix'><i class='ipconfig'>"+d+"</i><i class='os'>"+g+"</i><i class='status1'>密码错误</i><i class='status2'>不支持操作</i><span>删除</span></li>":-1==f?c+="<li class='clearfix'><i class='ipconfig'>"+d+"</i><i class='os'>"+g+"</i><i class='status1'>agent异常</i><i class='status2'>不支持操作</i><span>删除</span></li>":-2==f?c+="<li class='clearfix'><i class='ipconfig'>"+d+"</i><i class='os'>"+g+"</i><i class='status1'>格式错误</i><i class='status2'>不支持操作</i><span>删除</span></li>":-99==f&&(c+="<li class='clearfix'><i class='ipconfig'>"+d+"</i><i class='os'>"+g+"</i><i class='status1'>agent不存在</i><i class='status2'>不支持操作</i><span>删除</span></li>"))}if(a)for(var d in a){var e=a[d],f=e[0];"total"!=d&&"num"!=d&&1==f&&(c+="<li class='clearfix'><i class='ipconfig'>"+d+"</i><i class='os'>"+g+"</i><i class='status1'>agent正常</i><i class='status2'>支持操作</i><span>删除</span></li>")}b.append(c)}function vaild_ipfree(a,b){var c="";for(var d in a){var e=a[d],f=e[0],g=e[2];"total"!=d&&"num"!=d&&1!=f&&(-1==f?c+="<li class='clearfix'><i class='ipconfig'>"+d+"</i><i class='os'>"+g+"</i><i class='status1'>无权限操作</i><i class='status2 diswork'>不支持操作</i><span>删除</span></li>":-2==f?c+="<li class='clearfix'><i class='ipconfig'>"+d+"</i><i class='os'>"+g+"</i><i class='status1'>agent异常</i><i class='status2 diswork'>不支持操作</i><span>删除</span></li>":-99==f?c+="<li class='clearfix'><i class='ipconfig'>"+d+"</i><i class='os'>"+g+"</i><i class='status1'>agent未安装</i><i class='status2 diswork'>不支持操作</i><span>删除</span></li>":"unknown"==g&&(c+="<li class='clearfix'><i class='ipconfig'>"+d+"</i><i class='os'>"+g+"</i><i class='status1'>系统类型未设定</i><i class='status2 diswork'>不支持操作</i><span>删除</span></li>"))}if(a)for(var d in a){var e=a[d],f=e[0],g=e[2];"total"!=d&&"num"!=d&&1==f&&"unknown"!=g&&(c+="<li class='clearfix'><i class='ipconfig'>"+d+"</i><i class='os'>"+g+"</i><i class='status1'>agent正常</i><i class='status2'>支持操作</i><span>删除</span></li>")}b.append(c)}function vaild_ip2(a,b){var c="";for(var d in a)if("total"!=d&&"num"!=d){var e=a[d],f=e[0],g=e[2];1==f?c+="<li class='clearfix'><i class='ipconfig'>"+d+"</i><i class='os'>"+g+"</i><i class='status1'>agent正常</i><i class='status2'>支持操作</i><span>删除</span></li>":0==f?c+="<li class='clearfix'><i class='ipconfig'>"+d+"</i><i class='os'>"+g+"</i><i class='status1'>密码错误</i><i class='status2'>不支持操作</i><span>删除</span></li>":-1==f?c+="<li class='clearfix'><i class='ipconfig'>"+d+"</i><i class='os'>"+g+"</i><i class='status1'>agent异常</i><i class='status2'>不支持操作</i><span>删除</span></li>":-2==f?c+="<li class='clearfix'><i class='ipconfig'>"+d+"</i><i class='os'>"+g+"</i><i class='status1'>格式错误</i><i class='status2'>不支持操作</i><span>删除</span></li>":-99==f&&(c+="<li class='clearfix'><i class='ipconfig'>"+d+"</i><i class='os'>"+g+"</i><i class='status1'>agent不存在</i><i class='status2'>不支持操作</i><span>删除</span></li>")}b.append(c)}function delete_ip_hide(a,b,c,d){var e=$.parseJSON(a.val()),f=e[d],g=e.total,h=e.num;g-=1,e.total=g,"1"==f[0]&&(h-=1,e.num=h),delete e[d];var i=JSON.stringify(e);a.val(i),b.parent().remove(),c.html("涉及服务器["+g+"]台，仅[<span>"+h+"</span>]台支持操作")}function getEvent(){if(document.all)return window.event;for(func=getEvent.caller;null!=func;){var a=func.arguments[0];if(a&&(a.constructor==Event||a.constructor==MouseEvent||"object"==typeof a&&a.preventDefault&&a.stopPropagation))return a;func=func.caller}return null}function doit(){var a=getEvent();return a.keyCode<8?!1:a.keyCode>8&&a.keyCode<48?!1:a.keyCode>57&&a.keyCode<96?!1:a.keyCode>105?!1:!0}function check_toggle(a,b,c){a.on("ifChecked",function(){b.find(c).removeClass("hide")}),a.on("ifUnchecked",function(){b.find(c).addClass("hide")})}function template_edit(a){$.ajax({type:"GET",url:"/md_manage/edit/"+a+"/",dataType:"json",success:function(b){if(200==b.status){var c="template_edit_"+a,d="编辑模板【"+b.result.template_name+"】",e=b.result.html;tab_href(c,d,e);var f=b.result.work_type,g=$(".work_type_"+a);product_from(g,f)}else jError("出错了")}})}function product_from(a,b){$.ajax({type:"POST",url:"/usual/ajax_get_cmdb_product_returns/",dataType:"json",timeout:3e3,success:function(c){if(c){a.html("<option value=''>未分类</option>");var d="";$.each(c,function(a,c){d+=c.productname==b?"<option value="+c.productname+" selected>"+c.productname+"</option>":"<option value="+c.productname+">"+c.productname+"</option>"}),a.append(d)}else jError("获取所属业务失败！")},error:function(){jError("获取所属业务失败！")}})}function template_step_edit(a,b){var c=$("#edit_template_form_"+a);return $.ajax({type:"POST",url:"/md_manage/template_step/edit/"+a+"/",data:c.serialize(),dataType:"json",success:function(c){if(200==c.status){var d="template_step_edit_"+a,e="编辑模板步骤【"+c.result.name+"】",f=c.result.html;"script"==b?tab_href2(d,e,f):tab_href(d,e,f)}else jError("操作失败！")}}),!0}function sort_step(a){var b=a.parents(".edit-md-wrap");b.find(".edit_md_table tbody tr").each(function(){var a=$(this).index()+1;$(this).find("td:first").html("第"+a+"步")})}function sort_step2(a,b,c){sort_step(a),$.ajax({type:"POST",url:"/md_manage/sort/"+b+"/",data:{step_id_list:c},dataType:"json",success:function(a){200==a.status?jSuccess("操作成功"):jError("操作失败")},error:function(){jError("操作失败")}})}function check_ip_support(a){if(!a)return jNotify("无有效的Agent状态的IP"),!1;var b=$.parseJSON(a),c=b.total,d=b.num;return c!=d?(jNotify("存在不支持操作的机器，请删除!"),!1):0==d?(jNotify("支持操作的机器不能为空!"),!1):!0}function handle_edit_template_step(a,b,c,d,e){var f=$(d).attr("data-type"),g=$(d).attr("data-msg");if("script"==f){var h=$(d).parents(".edit-script-wrap"),i=h.find(".edit-script-name").val(),j=h.find(".edit-script-desc").val(),k=h.find(".edit-script-option").val(),l=h.find(".edit-script-version").val(),m=h.find(".edit-script-ip-hide").val(),n=h.find("#dst_use_own").prop("checked");if(!i||!j||""==k||""==l)return jNotify("有未填写的输入项，请检查！"),!1;if(1==n){var o=check_ip_support(m);if(0==o)return!1}}if("pullfile"==f){var h=$(d).parents(".edit-pullfile-wrap"),p=h.find(".edit-pullfile-name").val(),q=h.find(".edit-pullfile-desc").val(),r=h.find(".edit-pullfile-list li").length,s=h.find(".edit-pullfile-ip").val(),t=h.find(".edit-pullfile-path").val(),m=h.find(".edit-pullfile-ip-hide").val(),u=h.find(".edit-pullfile-file-hide"),v=h.find(".edit-pullfile-list li .file-road"),n=h.find("#dst_use_own").prop("checked");if(!(p&&q&&0!=r&&s&&t))return jNotify("有未填写的输入项，请检查！"),!1;if(1==n){var o=check_ip_support(m);if(0==o)return!1}var w=[];v.each(function(){w.push($(this).text())});for(var x=[],y=0,z=w.length;z>y;y++){var A=w[y];if(-1!=$.inArray(A,x))return jNotify("存在重复文件，请删除！"),!1;x.push(A)}var B=x.join(",");u.val(B)}if("text"==f){var h=$(d).parents(".edit-text-wrap"),C=h.find(".edit-text-name").val(),D=h.find(".edit-text-content").val();if(!C)return jNotify("步骤名称不能为空！"),!1;if(!D)return jNotify("文本描述不能为空！"),!1}if("sendfile"==f){var h=$(d).parents(".edit-sendfile-wrap"),E=h.find(".edit-sendfile-name").val(),F=h.find(".edit-sendfile-desc").val(),G=h.find(".edit-sendfile-ip li").length,H=h.find(".edit-sendfile-path").val(),m=h.find(".edit-sendfile-ip-hide").val(),n=h.find("#dst_use_own").prop("checked");if(!E||!F||0==G||!H)return jNotify("有未填写的输入项，请检查！"),!1;if(1==n){var o=check_ip_support(m);if(0==o)return!1}}if(1==e)if("sendfile"==f){var h=$(d).parents(".edit-sendfile-wrap"),I=h.find(".os"),J=h.find(".edit-sendfile-path"),o=check_system(I,J);if(0==o)return!1}else{var h=$(d).parents(".edit-pullfile-wrap"),I=h.find(".os"),J=h.find(".edit-pullfile-path"),o=check_system(I,J);if(0==o)return!1}return"job"==g?save_job(c,a,b):save_template(c,a,b),!1}function save_template(a,b,c){if(1==a){var d=$("#edit_template_step_form_"+b);$.ajax({type:"POST",url:"/md_manage/template_step/save/"+b+"/",data:d.serialize(),dataType:"json",success:function(a){200==a.status?(template_edit(c),template_step_edit(b),jSuccess(a.result.msg)):jError(a.result.msg)},error:function(){jError("保存步骤失败")}})}else $("#myTab li.active").find("i").trigger("click"),template_edit(c)}function save_job(a,b,c){if(1==a){var d=$("#edit_job_step_form_"+b);$.ajax({type:"POST",url:"/job/job_step/save/"+b+"/",data:d.serialize(),dataType:"json",success:function(a){200==a.status?(job_view(c),jSuccess(a.result.msg)):jError(a.result.msg)},error:function(){jError("保存步骤失败")}})}else $("#myTab li.active").find("i").trigger("click"),job_view(c)}function add_ip(a,b,c,d,e,f,g){var g=g||"/ajax_pwd_valid/1/",h=a.val().trim().replace(new RegExp("	","g")," "),i=h.split("\n"),j=b.val();return h?(compare_ip(i),c.parent().removeClass("hide"),c.empty(),filter_ip(i,c),d.button("loading"),e.addClass("disabled"),$.ajax({type:"POST",url:g,data:{iptxt:h,hidetxt:j},dataType:"json",error:function(a){return jError(a.responseText),!1},success:function(a){d.button("complete").html("<i class='icon-plus'></i>ip添加"),e.removeClass("disabled"),c.parent().removeClass("hide"),b.val(a.ip_dict);var g=$.parseJSON(a.ip_dict);f.html("涉及服务器["+g.total+"]台，仅["+g.num+"]台支持操作"),c.empty(),vaild_ip(g,c)}}),!0):(jNotify("请填写目标机器信息！"),a.focus(),!1)}function add_ipfree(a,b,c,d,e,f,g){var h=a.val().trim(),i=h.split("\n");b.val();if(!h)return jNotify("请填写目标机器信息！"),a.focus(),!1;if("pwd"==g){compare_ip(i);var j=compare_ip(i);if(0==j)return!1}else compare_ipfree(i);c.parent().removeClass("hide"),c.empty(),filter_ipfree(i,c,g);for(var k=[],l=c.find(".ipconfig"),m=0,n=l.length;n>m;m++)k.push(l.eq(m).text());var o=[];if("pwd"==g)for(var p=c.find(".pwdconfig"),m=0,n=p.length;n>m;m++)o.push(p.eq(m).text());return""==k?(jNotify("存在错误ip或输入格式，请检查！"),!1):(d.button("loading"),e.addClass("disabled"),$.ajax({type:"post",url:"/usual/ajax_get_cmdb_ipvalid_returns/",data:{iplist:k},dataType:"json",error:function(a){return jError(a.responseText),!1},success:function(a){d.button("complete").html("<i class='icon-plus'></i>ip添加"),e.removeClass("disabled"),c.parent().removeClass("hide"),c.empty(),vaild_ipfree(a,c);var h=c.find("li").length,i=c.find(".diswork").length,j=h-i;if(a.total=h,a.num=j,"pwd"==g)for(var l=0,m=k.length;m>l;l++){var n=k[l],p=a[n];p[1]=o[l]}f.html("涉及服务器["+h+"]台，仅["+j+"]台支持操作"),b.val(JSON.stringify(a))}}),!0)}function add_ip2(a,b,c,d,e,f){var g=a.val().trim().replace(new RegExp("	","g")," "),h=g.split("\n"),i=b.val();return g?(compare_ip(h),c.parent().removeClass("hide"),c.empty(),filter_ip(h,c),d.button("loading"),e.addClass("disabled"),$.ajax({type:"POST",url:"/ajax_pwd_valid/2/",data:{iptxt:g,hidetxt:i},dataType:"json",error:function(a){return jError(a.responseText),!1},success:function(a){d.button("complete").html("<i class='icon-plus'></i>ip添加"),e.removeClass("disabled"),c.parent().removeClass("hide"),b.val(a.ip_dict);var g=$.parseJSON(a.ip_dict);f.html("涉及服务器["+g.total+"]台，仅["+g.num+"]台支持操作"),c.empty(),vaild_ip2(g,c)}}),!0):(jNotify("请填写目标机器信息！"),a.focus(),!1)}function check_system(a,b){for(var c=1;c<a.length;c++)if(a.eq(c).text().toLowerCase().substr(0,2)!=a.eq(0).text().toLowerCase().substr(0,2))return jNotify("目标机器操作系统不一致，保存失败！"),result=!1;if(0==a.eq(0).text().toLowerCase().indexOf("win")){var d=/^[a-zA-Z]:\\(?:[-\\w\\.\\d]+\\)*(?:[-\\w\\.\\d]+)?/;if(!d.test(b.val()))return jNotify("非法的windows路径！"),!1;var e=/^[^"'?><*|]*$/;if(!e.test(b.val()))return jNotify("包含特殊字符！(\"'?><*|)"),!1}if("linux"==a.eq(0).text().toLowerCase()){var f=/^(\/([0-9a-zA-Z]+))+/;if(!f.test(b.val()))return jNotify("非法的linux路径！"),!1}return-1!=b.val().indexOf("\\\\")||-1!=b.val().indexOf("//")?(jNotify("路径中不能有重复的' / '或者' \\ '"),!1):!0}function del_file(a){$(a).parent(".list2").remove()}function job_view(a){$.ajax({type:"GET",url:"/job/job_view/",data:{job_id:a},dataType:"json",success:function(a){if(500==a.status)jError(a.msg);else{var b="job_view_"+a.job_id,c="作业实例",d=a.html;tab_href(b,c,d)}},error:function(){}})}function job_step_edit(a,b){return $.ajax({type:"POST",url:"/job/job_step/edit/"+a+"/",dataType:"json",success:function(c){if(200==c.status){var d="job_step_edit_"+a,e="编辑实例步骤【"+c.result.name+"】",f=c.result.html;"script"==b?tab_href2(d,e,f):tab_href(d,e,f)}else jError("操作失败！")}}),!0}function script_filter(){var a=$("#script_manage_name").val(),b=$("#script_manage_describe").val(),c=$("#script_manage_create_user").val(),d=$("#script_manage_created_from").val(),e=$("#script_manage_created_to").val();d&&e&&time_compare(d,e),oTable_script_manage.fnReloadAjax("/script_manage/list/?p=0&name="+a+"&create_user="+c+"&describe="+b+"&created_from="+d+"&created_to="+e)}function show_script_add(){$.ajax({type:"GET",url:"/script/script_add/",dataType:"json",success:function(a){var b="script_add_info_"+a.check_id,c="新建作业脚本",d=a.html;tab_href2(b,c,d)},error:function(){jError("出错了")}})}function script_manage_delete(a){1==confirm("是否真的要删除指定的内容？")&&$.ajax({type:"POST",url:"/script/script_delete/",data:{script_id:a},dataType:"json",success:function(a){1==a.result?jSuccess("删除成功！"):0==a.result&&jError(a.showMsg),$("#script_manage").empty(),$("#script_manage").html(a.html)},error:function(a,b){}})}function script_manage_view(a){$.ajax({type:"POST",url:"/script/script_view/",data:{script_id:a},dataType:"json",success:function(a){if(500==a.status)jError("获取脚本内容失败");else{var b="script_view_"+a.script_id,c="查看脚本",d=a.html;tab_href(b,c,d)}},error:function(){jError("获取脚本内容失败")}})}function template_step_script_view(a){var b=$("#edit_template_step_form_"+a).find("#step_script").val();""==b?jNotify("请选择脚本后再查看"):script_manage_view(b)}function version_delete(a){1==confirm("是否真的要删除指定的内容？")&&$.ajax({type:"POST",url:"/script/version_delete/",data:{version_id:a},dataType:"json",success:function(a){1==a.result?jSuccess("删除成功！"):0==a.result&&jError(a.showMsg),$("#script_view_"+a.script_id).empty(),$("#script_view_"+a.script_id).html(a.html)},error:function(a,b){}})}function show_version_detail(a){$.ajax({type:"POST",url:"/script/show_version_detail/",data:{version_id:a},dataType:"json",success:function(a){if(500==a.status)jError("查看版本详细失败!");else{var b="version_detail_"+a.version_id,c="脚本详细",d=a.html;tab_href2(b,c,d)}},error:function(a,b){}})}function version_copy(a){$.ajax({type:"GET",url:"/script/version_copy/",data:{version_id:a},dataType:"json",success:function(a){if(500==a.status)jError("复制并新建版本失败!");else{var b="version_copy_"+a.version_id,c="复制并新建",d=a.html;tab_href2(b,c,d)}},error:function(a,b){}})}function version_remarks_edit(a){$.ajax({type:"GET",url:"/script/version_remarks_edit/",data:{version_id:a},dataType:"json",success:function(a){0==a.result?jError("修改版本备注失败!"):($("#edit_remarks").html(a.html),$("#edit_remarks").modal("show"))},error:function(a,b){}})}function version_remarks_save(a){var b=$("#version_remarks_"+a).val();$("#edit_remarks").modal("hide"),$.ajax({type:"GET",url:"/script/version_remarks_save/",data:{version_id:a,version_remarks:b},dataType:"json",success:function(a){500==a.status?jError("编辑版本备注失败!"):($("#script_view_"+a.script_id).empty(),$("#script_view_"+a.script_id).html(a.html),jSuccess("编辑版本备注成功!"))},error:function(a,b){}})}function script_manage_edit(a){var b=$("#script_manage_view_name_"+a).val(),c=$("#script_manage_view_describe_"+a).val();return b?void $.ajax({type:"POST",url:"/script/script_edit/",dataType:"json",data:{script_id:a,script_name:b,script_describe:c},success:function(b){if(500==b.status)jError(b.msg);else{var c="script_view_"+a,d="查看脚本",e=b.html;tab_href(c,d,e),jSuccess("保存脚本成功!")}},error:function(){jError("保存脚本失败!")}}):(jNotify("请输入脚本名称"),!1)}function refresh_accounts(a){var b=$(a).parents(".row-fluid").find(".account-msg");$.ajax({type:"GET",url:"/account/get_account_list/",dataType:"json",success:function(a){200==a.status?(b.html('<option value="" selected>请选择执行账户</option>'),$.each(a.result.accounts,function(a,c){b.append('<option value="'+c.a_id+'" >'+c.a_name+"</option>")}),jSuccess("账户列表更新成功")):jError(a.result.msg)},error:function(){jError("账户列表更新失败")}})}function template_step_refresh_script_list(a){$.ajax({type:"GET",url:"/md_manage/get_script_list/",dataType:"json",success:function(b){var c=$("#edit_template_step_form_"+a).find("#step_script"),d=$("#edit_template_step_form_"+a).find("#step_version");200==b.status?(c.html('<option value="" selected>请选择步骤脚本</option>'),d.html('<option value="" selected>请选择版本</option>'),$.each(b.result.scripts,function(a,b){c.append('<option value="'+b.s_id+'" >'+b.s_name+"</option>")}),jSuccess("脚本列表更新成功")):jError(b.result.msg)},error:function(){jError("脚本列表更新失败")}})}function template_del(a){1==confirm("是否真的要删除该模板？")&&$.ajax({url:"/md_manage/delete/"+a+"/",dataType:"json",success:function(a){200==a.status?($("#myTab li.active").find("i").trigger("click"),template_filter(),jSuccess("删除成功！")):500==a.status&&jError(a.result.msg)},error:function(a,b){jError("出错了")}})}function example_manage_add(a){$.ajax({type:"GET",url:"/job/job_add/",data:{template_id:a},dataType:"json",success:function(a){if(500==a.status)jError("添加实例失败!");else{var b="job_view_"+a.job_id,c="作业实例",d=a.html;tab_href(b,c,d)}},error:function(a,b){}})}function submit_create_new_template(a){var b=check_job_name($("#id_name"),$("#id_remarks"));if(0==b)return!1;var c=$("#new_template_form_"+a);return $.ajax({type:"POST",url:"/md_manage/add/",data:c.serialize(),dataType:"json",success:function(a){200==a.status?($("#myTab li.active").find("i").trigger("click"),template_view(a.result.template_id),template_filter(),jSuccess("新作业模板创建成功！")):($("#template_add_info").html(a.result.html),jError("作业模板创建失败！"))}}),!0}function job_delete(a,b){1==confirm("是否真的要删除指定的内容？")&&$.ajax({type:"POST",url:"/job/job_delete/",data:{job_id:a},dataType:"json",success:function(a){1==a.result?jSuccess("删除成功！"):0==a.result&&jError("删除失败！"),$("#refresh_job_list_"+b).click()},error:function(a,b){}})}function job_copy(a){$("#loading-panel").show().css({"z-index":1e3}).animate({opacity:"1"},100),$.ajax({type:"GET",url:"/job/job_copy/",data:{job_id:a},dataType:"json",success:function(a){if(500==a.status)jError("复制并新建实例失败!");else{var b="job_view_"+a.job_id,c="作业实例",d=a.html;tab_href(b,c,d)}$("#loading-panel").animate({opacity:"0"},200).hide().css({"z-index":-999})},error:function(a,b){$("#loading-panel").animate({opacity:"0"},200).hide().css({"z-index":-999})}})}function show_result(a){$.ajax({type:"POST",url:"/history/show_result/"+a+"/",dataType:"json",async:!0,data:{},success:function(b){var c=b.result,d="exec_result_"+a,e=c.job_name+"-执行",f=b.result.html;tab_href(d,e,f)},error:function(){jError("出错了")}})}function showPswResults(a,b,c){var d=0,e=setInterval(function(){d+=5,d>60&&clearInterval(e),$("#psw_result").empty(),$.ajax({type:"POST",url:"/usual/ajax_get_psw_returns/",data:{jid_list:a,ip_list:b},dataType:"json",success:function(a){$("#psw_result").empty(),a.res.length==c&&clearInterval(e);for(var b=0;b<a.res.length;b++)$("#psw_result").append("<li><i class='ipconfig'>"+a.res[b].minion_ip+"</i><i class='loading'>"+a.res[b].result_str+"</i></li>")}})},5e3)}function showRebootResults(a,b,c){var d=0,e=setInterval(function(){d+=5,d>60&&clearInterval(e),$("#reboot_result").empty(),$.ajax({type:"POST",url:"/usual/ajax_get_reboot_returns/",data:{jid:a,ip_list:b},dataType:"json",success:function(a){$("#reboot_result").empty(),a.res.length==c&&clearInterval(e);for(var b=0;b<a.res.length;b++)$("#reboot_result").append("<li><i class='ipconfig'>"+a.res[b].minion_ip+"</i><i class='loading'>"+a.res[b].result_str+"</i></li>")}})},5e3)}function rule_model(a){var b=$(a).parents(".modify-timing-modal"),c=b.find(".expression"),d=b.find(".note"),e=b.find(".executor");return c.val()&&d.val()&&e.val()?void 0:(jNotify("有未填写的输入项，请检查！"),!1)}function show_history_info(a){return $.ajax({type:"POST",url:"/history/"+a+"/",dataType:"json",async:!0,data:{},success:function(b){var c=b.result,d="exec_job_info_"+a,e=c.job_name,f=b.result.html;tab_href(d,e,f)},error:function(){jError("出错了")}}),!1}function sum_add_account(){var a=/^\w+$/,b=/^[\u4e00-\u9fa5A-Za-z0-9-_]*$/,c=$("#id_name").val(),d=$("#id_name_abbr").val(),e=$("#id_password").val();return a.test(c)?b.test(d)?c.length>20?(jNotify("账户名称不能超过20个字符"),!1):d.length>100?(jNotify("账户名称不能超过100个字符"),!1):e.length>20?(jNotify("账户密码不能超过20个字符"),!1):($.ajax({type:"POST",url:"/account/add/",data:$("#addaccountform").serialize(),dataType:"json",success:function(a){$("#account_add").empty(),$("#account_add").html(a.html),1==a.result&&jSuccess("保存账户成功！")}}),!0):(jNotify("账户别名只能由中英文、数字、下划线或者减号组成！"),!1):(jNotify("账户名称只能由数字、英文字母或者下划线组成！"),!1)}function account_edit(a,b){$.ajax({type:"GET",url:"/account/edit/"+a+"/",dataType:"json",success:function(c){var d="account_edit_"+a,e="账户["+b+"]",f=c.html;tab_href(d,e,f)},error:function(a,b){}})}function account_del(a,b,c){1==confirm("是否真的要删除指定的内容？")&&$.ajax({type:c,url:b,data:a.serialize(),dataType:"json",success:function(a){1==a.result?jSuccess("删除成功！"):0==a.result&&jError("删除失败！"),
$("#account").empty(),$("#account").html(a.html)},error:function(a,b){}})}function account_filter(){var a=$("#account_name").val(),b=$("#account_name_abbr").val(),c=$("#account_update_user").val(),d=$("#account_created_from").val(),e=$("#account_created_to").val(),f=$("#account_updated_from").val(),g=$("#account_updated_to").val();return d&&e&&(result=time_compare(d,e),!result)?!1:f&&g&&(result=time_compare(f,g),!result)?!1:void oTable_account.fnReloadAjax("/account/list/?p=0&name="+a+"&name_abbr="+b+"&update_user="+c+"&created_from="+d+"&created_to="+e+"&updated_from="+f+"&updated_to="+g)}function job_manage_filter(){var a=$("#job_manage_name").val(),b=$("#job_manage_create_user").val(),c=$("#job_manage_created_from").val(),d=$("#job_manage_created_to").val(),e=$("#job_manage_update_user").val(),f=$("#job_manage_updated_from").val(),g=$("#job_manage_updated_to").val();return c&&d&&(result=time_compare(c,d),!result)?!1:f&&g&&(result=time_compare(f,g),!result)?!1:void oTable_job_manage.fnReloadAjax("/example_manage/list/?p=0&name="+a+"&create_user="+b+"&update_user="+e+"&created_from="+c+"&created_to="+d+"&updated_from="+f+"&updated_to="+g)}function job_edit(a){var b=[];$("#example_view_form_"+a).find("input:checked").each(function(){b.push($(this).val())});var c=$("#example_view_name_"+a).val(),d=$("#example_view_remarks_"+a).val();return c?void $.ajax({type:"POST",url:"/job/job_view/",data:{job_id:a,job_name:c,job_remarks:d,check_list:b},dataType:"json",success:function(a){500==a.status?jError(a.msg):jSuccess("保存实例成功!")},error:function(a,b){}}):(jError("实例名称不能为空!"),!1)}function job_full_setting_save(a){var b=$("#edit_job_form_settings_"+a);return $.ajax({type:"POST",url:"/job/save_full_setting/"+a+"/",data:b.serialize(),dataType:"json",success:function(a){200==a.status?jSuccess("操作成功！"):jError(a.result.msg)}}),!0}function job_start_now(a){return $.ajax({type:"POST",url:"/job/job_start_now/"+a+"/",dataType:"json",success:function(a){200==a.status?(show_result(a.result.history_id),jSuccess("操作成功！")):jError(a.result.msg)}}),!0}function show_schedule_new(a){var b=$("#set_timing_"+a);return $.ajax({type:"get",url:"/timing_manage/add/"+a+"/",dataType:"json",success:function(a){500==a.status?jError(a.result.msg):(b.html(a.result.html),b.modal("show"))},error:function(a,b){jError("页面显示失败")}}),!1}function schedule_save(a,b,c){var d=$("#schedule_add_"+a),e=rule_model(c);return 0==e?!1:($.ajax({type:"POST",url:"/timing_manage/add/"+b+"/",data:d.serialize(),dataType:"json",success:function(a){200==a.status?(jSuccess("定时任务创建成功！"),$("#set_timing_"+b).modal("hide"),schedule_filter()):jError(a.result.msg)},error:function(){jError("定时任务创建失败")}}),!0)}function history_filter(){var a=$("#history_job_name").val(),b=$("#history_user").val(),c=$("#history_start_from").val(),d=$("#history_start_to").val(),e=$("#history_status").val(),f=$("#history_template_type").val(),g=$("#history_template_step").val(),h=$("#history_end_from").val(),i=$("#history_end_to").val(),j=$("#history_template_result").val();return c&&d&&(result=time_compare(c,d),!result)?!1:h&&i&&(result=time_compare(h,i),!result)?!1:void oTable_history.fnReloadAjax("/history/list/?p=0&job_name="+a+"&history_user="+b+"&start_from="+c+"&start_to="+d+"&history_status="+e+"&template_type="+f+"&template_step="+g+"&end_from="+h+"&end_to="+i+"&template_result="+j)}function show_history_step_info(a,b){$.ajax({type:"GET",url:"/history/ajax_show_history_step_info/"+a+"/",dataType:"json",async:!0,success:function(a){var c=a.result;200==a.status?$("#history_step_info_"+b).html(c.html):jError(c.msg)},error:function(){jError("出错了")}})}function show_template_add(){$.ajax({type:"GET",url:"/md_manage/add/",data:{},success:function(a){var b="template_add_info",c="新建作业模板",d=a;tab_href(b,c,d)},error:function(){jError("出错了")}})}function submit_edit_template(a){var b=check_job_name($("#id_name"),$("#id_remarks"));if(0==b)return!1;var c=$("#edit_template_form_"+a);return $.ajax({type:"POST",url:"/md_manage/edit/"+a+"/",data:c.serialize(),dataType:"json",success:function(b){if(200==b.status)$("#myTab li.active").find("i").trigger("click"),template_view(b.result.template_id),template_filter(),jSuccess("操作成功！");else{var c="template_edit_"+a,d="编辑作业【"+b.result.template_name+"】",e=b.result.html;tab_href(c,d,e),jError("操作失败！")}}}),!0}function template_full_setting_save(a){var b=$("#edit_template_form_settings_"+a);return $.ajax({type:"POST",url:"/md_manage/save_full_setting/"+a+"/",data:b.serialize(),dataType:"json",success:function(a){200==a.status?jSuccess("操作成功！"):jError(a.result.msg)}}),!0}function script_once_detail(a,b,c){$.ajax({type:"POST",url:"/script/script_detail/"+a+"/"+b+"/",dataType:"json",async:!0,data:{},success:function(b){var d=b.result,e="script_detail_"+a,f=c+"-执行详细",g=d.html;tab_href(e,f,g)},error:function(){}})}function show_script_instance(a){$.ajax({type:"POST",url:"/history/"+a+"/",dataType:"json",async:!0,data:{},success:function(a){var b=a.result,c="exec_job_info_"+b.job_name,d=b.job_name,e=a.result.html;tab_href(c,d,e)},error:function(){jError("出错了")}})}function version_sync(a){$.ajax({type:"GET",url:"/script/version_template_sync/",data:{version_id:a},dataType:"json",success:function(b){if(500==b.status)jError("同步版本失败!");else{var c="version_sync_"+a,d="同步版本",e=b.html;tab_href(c,d,e)}},error:function(a,b){}})}function version_job_sync(a,b){return $.ajax({type:"get",url:"/script/version_job_sync/",data:{version_id:a,template_id:b},dataType:"json",success:function(b){500==b.status?jError("替换实例步骤版本失败!"):($("#select_example_step_"+a).html(b.html),$("#select_example_step_"+a).modal("show"))},error:function(a,b){}}),!1}function version_job_sync_save(a){if(0==$(".update_step_checked_it_"+a).filter(":checked").length)return jNotify("指定实例步骤列表为空，替换脚本版本失败！"),!1;var b=[];return $("#select_example_step_"+a).find("input:checked").each(function(){b.push($(this).val())}),$.ajax({type:"post",url:"/script/version_job_sync/",data:{version_id:a,check_list:b},dataType:"json",success:function(b){500==b.status?jError("替换实例步骤版本失败!"):(jSuccess("替换实例步骤版本成功!"),$("#select_example_step_"+a).modal("hide"))},error:function(a,b){}}),!1}var ani_start=function(){function a(){var a=$.Deferred();return $(".step-show2").delay(800).animate({opacity:1},500,function(){a.resolve()}),a}function b(){var a=$.Deferred();return $(".step-show3").animate({opacity:1},500,function(){a.resolve()}),a}function c(){var a=$.Deferred();return $(".step-show4").animate({opacity:1},500,function(){a.resolve()}),a}$(".step-show1 span").addClass("zoomIn").addClass("animated");var d=a();d.then(function(){return b()}).then(function(){return c()})};